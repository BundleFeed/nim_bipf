/* Generated by Nim Compiler v1.9.3 */
#define NIM_INTBITS 64

#include "nimbase.h"
#include <copyfile.h>
#include <unistd.h>
#include <errno.h>
#undef LANGUAGE_C
#undef MIPSEB
#undef MIPSEL
#undef PPC
#undef R3000
#undef R4000
#undef i386
#undef linux
#undef mips
#undef near
#undef far
#undef powerpc
#undef unix
#define nimfr_(x, y)
#define nimln_(x, y)
typedef struct NimStrPayload NimStrPayload;
typedef struct NimStringV2 NimStringV2;
typedef struct tyTuple__UV3llMMYFckfui8YMBuUZA tyTuple__UV3llMMYFckfui8YMBuUZA;
typedef struct Exception Exception;
typedef struct RootObj RootObj;
typedef struct TNimTypeV2 TNimTypeV2;
typedef struct tySequence__9bNRJkU9cJnNkESCDTQ7DgcQ tySequence__9bNRJkU9cJnNkESCDTQ7DgcQ;
typedef struct tySequence__9bNRJkU9cJnNkESCDTQ7DgcQ_Content tySequence__9bNRJkU9cJnNkESCDTQ7DgcQ_Content;
typedef struct tyObject_StackTraceEntry__2Xjg6E7TZG7p9bcgUNTKHrg tyObject_StackTraceEntry__2Xjg6E7TZG7p9bcgUNTKHrg;
struct NimStrPayload {
NI cap;
NIM_CHAR data[SEQ_DECL_SIZE];
};
struct NimStringV2 {
NI len;
NimStrPayload* p;
};
typedef NU8 tySet_tyEnum_CopyFlag__PhjQnly1eh0L5Y629aI50ag;
typedef NU8 tyEnum_CopyFlag__PhjQnly1eh0L5Y629aI50ag;
struct tyTuple__UV3llMMYFckfui8YMBuUZA {
NimStringV2 Field0;
NimStringV2 Field1;
};
struct TNimTypeV2 {
void* destructor;
NI size;
NI16 align;
NI16 depth;
NU32* display;
void* traceImpl;
void* typeInfoV1;
NI flags;
};
struct RootObj {
TNimTypeV2* m_type;
};
struct tySequence__9bNRJkU9cJnNkESCDTQ7DgcQ {
  NI len; tySequence__9bNRJkU9cJnNkESCDTQ7DgcQ_Content* p;
};
struct Exception {
  RootObj Sup;
Exception* parent;
NCSTRING name;
NimStringV2 message;
tySequence__9bNRJkU9cJnNkESCDTQ7DgcQ trace;
Exception* up;
};
struct tyObject_StackTraceEntry__2Xjg6E7TZG7p9bcgUNTKHrg {
NCSTRING procname;
NI line;
NCSTRING filename;
};


#ifndef tySequence__9bNRJkU9cJnNkESCDTQ7DgcQ_Content_PP
#define tySequence__9bNRJkU9cJnNkESCDTQ7DgcQ_Content_PP
struct tySequence__9bNRJkU9cJnNkESCDTQ7DgcQ_Content { NI cap; tyObject_StackTraceEntry__2Xjg6E7TZG7p9bcgUNTKHrg data[SEQ_DECL_SIZE];};
#endif

      N_LIB_PRIVATE N_NIMCALL(NIM_BOOL, tryMoveFSObject__stdZprivateZoscommon_96)(NimStringV2 source__JHO6Mxbd2679bzY6BaBxm9cg, NimStringV2 dest__zwT1XcVi4F8TVPiSdYXnlw, NIM_BOOL isDir__sF9aMD1wKTEE2FgK7RzoEYg);
N_LIB_PRIVATE N_NIMCALL(void, noscopyFile)(NimStringV2 source__eoCVFNpLZVLXwyKu7SJhzg, NimStringV2 dest__C3yHuHrfbm8qUZjgenJyMA, tySet_tyEnum_CopyFlag__PhjQnly1eh0L5Y629aI50ag options__luhms5PVEQqqSFobm4FG3Q);
static N_INLINE(NI, countBits32)(NU32 n__FH4h5o8YgMusQRfvXC9bMQw);
static N_INLINE(NI, countSetBitsImpl__systemZcountbits95impl_26)(NU32 x__lBpUDaHE7cyO1RecOwuFSA);
N_CDECL(int, __builtin_popcount)(unsigned int x__Wozjr2J64phFy36spnvw4g);
static N_INLINE(NIM_BOOL*, nimErrorFlag)(void);
N_LIB_PRIVATE N_NIMCALL(void, failedAssertImpl__stdZassertions_272)(NimStringV2 msg__K3q0fL6aLKe9by6qIeCq9c1A);
N_LIB_PRIVATE N_NIMCALL(NIM_BOOL, nossymlinkExists)(NimStringV2 link__RFQEuccmOm7K5GUW5SrU1g);
N_LIB_PRIVATE N_NIMCALL(void, createSymlink__stdZprivateZossymlinks_10)(NimStringV2 src__mLkZUm08XDJJR2PITc7z3Q, NimStringV2 dest__pvxedfDM6K9cqjwy9a8ublJw);
N_LIB_PRIVATE N_NIMCALL(NimStringV2, expandSymlink__stdZprivateZossymlinks_16)(NimStringV2 symlinkPath__6JU2TDGof9c5PfvfgS78Dpg);
N_LIB_PRIVATE N_NIMCALL(void, eqdestroy___stdZassertions_30)(NimStringV2* dest__C2JKGPCNdWKCPrsQvNywTQ);
static N_INLINE(NCSTRING, nimToCStringConv)(NimStringV2 s__UF7MRy5Ww0D3yXFWtooEkw);
N_LIB_PRIVATE N_NIMCALL(NI32, osLastError__stdZoserrors_101)(void);
N_LIB_PRIVATE N_NOINLINE(void, raiseOSError__stdZoserrors_98)(NI32 errorCode__pW4c9aJEinlYI1jZIvhGnmw, NimStringV2 additionalInfo__B0aylqmo75KM1PZjhD2Ciw);
N_LIB_PRIVATE N_NIMCALL(NimStringV2, dollar___stdZprivateZoscommon_103)(tyTuple__UV3llMMYFckfui8YMBuUZA* x__3gbgphmPr2YyFiVFGB9c3cA);
N_LIB_PRIVATE N_NIMCALL(void, nosremoveFile)(NimStringV2 file__J7TxM2NvlX9btMhQD9bZz39bA);
N_LIB_PRIVATE N_NIMCALL(NIM_BOOL, nostryRemoveFile)(NimStringV2 file__SkPQ5IAKGO9cnoeVcTqgQ3w);
N_LIB_PRIVATE N_NIMCALL(void, reraiseException)(void);
static N_INLINE(void, popCurrentException)(void);
N_LIB_PRIVATE N_NIMCALL(void, eqcopy___stdZtypedthreads_194)(Exception** dest__cPsQoh9cm9b0MsvPwH2WsNpA, Exception* src__kZusHwFBCWGwz62X46vnaQ, NIM_BOOL cyclic__1v1nrKo9cuZLkSh09aX9ax2hA);
static const struct {
  NI cap; NIM_CHAR data[108+1];
} TM__CMIme9a8i2wZOUbxErcFpJA_2 = { 108 | NIM_STRLIT_FLAG, "osfiles.nim(209, 3) `card(copyFlagSymlink * options) == 1` There should be exactly one cfSymlink* in options" };
static const NimStringV2 TM__CMIme9a8i2wZOUbxErcFpJA_3 = {108, (NimStrPayload*)&TM__CMIme9a8i2wZOUbxErcFpJA_2};
extern NIM_THREADVAR NIM_BOOL nimInErrorMode__system_4297;
extern NIM_THREADVAR Exception* currException__system_3940;
extern NIM_THREADVAR Exception* currException__system_3940;
static N_INLINE(NI, countSetBitsImpl__systemZcountbits95impl_26)(NU32 x__lBpUDaHE7cyO1RecOwuFSA) {
	NI result;
	NU32 x_2;
	int T1_;
	result = (NI)0;
	x_2 = x__lBpUDaHE7cyO1RecOwuFSA;
	T1_ = (int)0;
	T1_ = __builtin_popcount(x_2);
	result = ((NI) (T1_));
	return result;
}
static N_INLINE(NIM_BOOL*, nimErrorFlag)(void) {
	NIM_BOOL* result;
	result = (NIM_BOOL*)0;
	result = (&nimInErrorMode__system_4297);
	return result;
}
static N_INLINE(NI, countBits32)(NU32 n__FH4h5o8YgMusQRfvXC9bMQw) {
	NI result;
NIM_BOOL* nimErr_;
{nimErr_ = nimErrorFlag();
	result = (NI)0;
	result = countSetBitsImpl__systemZcountbits95impl_26(n__FH4h5o8YgMusQRfvXC9bMQw);
	if (NIM_UNLIKELY(*nimErr_)) goto BeforeRet_;
	}BeforeRet_: ;
	return result;
}
static N_INLINE(NCSTRING, nimToCStringConv)(NimStringV2 s__UF7MRy5Ww0D3yXFWtooEkw) {
	NCSTRING result;
	result = (NCSTRING)0;
	{
		if (!(s__UF7MRy5Ww0D3yXFWtooEkw.len == ((NI)0))) goto LA3_;
		result = "";
	}
	goto LA1_;
	LA3_: ;
	{
		result = ((NCSTRING) ((*s__UF7MRy5Ww0D3yXFWtooEkw.p).data));
	}
	LA1_: ;
	return result;
}
N_LIB_PRIVATE N_NIMCALL(void, noscopyFile)(NimStringV2 source__eoCVFNpLZVLXwyKu7SJhzg, NimStringV2 dest__C3yHuHrfbm8qUZjgenJyMA, tySet_tyEnum_CopyFlag__PhjQnly1eh0L5Y629aI50ag options__luhms5PVEQqqSFobm4FG3Q) {
	NIM_BOOL isSymlink;
NIM_BOOL* nimErr_;
{nimErr_ = nimErrorFlag();
	{
		if (!!((countBits32((7 & options__luhms5PVEQqqSFobm4FG3Q)) == ((NI)1)))) goto LA3_;
		failedAssertImpl__stdZassertions_272(TM__CMIme9a8i2wZOUbxErcFpJA_3);
		if (NIM_UNLIKELY(*nimErr_)) goto BeforeRet_;
	}
	LA3_: ;
	isSymlink = nossymlinkExists(source__eoCVFNpLZVLXwyKu7SJhzg);
	if (NIM_UNLIKELY(*nimErr_)) goto BeforeRet_;
	{
		NIM_BOOL T7_;
		NIM_BOOL T9_;
		T7_ = (NIM_BOOL)0;
		T7_ = isSymlink;
		if (!(T7_)) goto LA8_;
		T9_ = (NIM_BOOL)0;
		T9_ = ((options__luhms5PVEQqqSFobm4FG3Q &((NU8)1<<((NU)((((tyEnum_CopyFlag__PhjQnly1eh0L5Y629aI50ag)2)))&7U)))!=0);
		if (T9_) goto LA10_;
		T9_ = NIM_FALSE;
		LA10_: ;
		T7_ = T9_;
		LA8_: ;
		if (!T7_) goto LA11_;
		goto BeforeRet_;
	}
	LA11_: ;
	{
		NIM_BOOL T15_;
		NimStringV2 colontmpD_;
		T15_ = (NIM_BOOL)0;
		T15_ = isSymlink;
		if (!(T15_)) goto LA16_;
		T15_ = ((options__luhms5PVEQqqSFobm4FG3Q &((NU8)1<<((NU)((((tyEnum_CopyFlag__PhjQnly1eh0L5Y629aI50ag)0)))&7U)))!=0);
		LA16_: ;
		if (!T15_) goto LA17_;
		colontmpD_.len = 0; colontmpD_.p = NIM_NIL;
		colontmpD_ = expandSymlink__stdZprivateZossymlinks_16(source__eoCVFNpLZVLXwyKu7SJhzg);
		if (NIM_UNLIKELY(*nimErr_)) goto LA19_;
		createSymlink__stdZprivateZossymlinks_10(colontmpD_, dest__C3yHuHrfbm8qUZjgenJyMA);
		if (NIM_UNLIKELY(*nimErr_)) goto LA19_;
		{
			LA19_:;
		}
		{
			eqdestroy___stdZassertions_30((&colontmpD_));
		}
		if (NIM_UNLIKELY(*nimErr_)) goto BeforeRet_;
	}
	goto LA13_;
	LA17_: ;
	{
		copyfile_state_t state;
		int status;
		int status2;
		state = copyfile_state_alloc();
		status = copyfile(nimToCStringConv(source__eoCVFNpLZVLXwyKu7SJhzg), nimToCStringConv(dest__C3yHuHrfbm8qUZjgenJyMA), state, COPYFILE_DATA);
		{
			NimStringV2 colontmpD__2;
			NI32 err;
			int T28_;
			tyTuple__UV3llMMYFckfui8YMBuUZA T29_;
			if (!!((status == ((NI32)0)))) goto LA25_;
			colontmpD__2.len = 0; colontmpD__2.p = NIM_NIL;
			err = osLastError__stdZoserrors_101();
			if (NIM_UNLIKELY(*nimErr_)) goto LA27_;
			T28_ = (int)0;
			T28_ = copyfile_state_free(state);
			(void)(T28_);
			T29_.Field0 = source__eoCVFNpLZVLXwyKu7SJhzg;
			T29_.Field1 = dest__C3yHuHrfbm8qUZjgenJyMA;
			colontmpD__2 = dollar___stdZprivateZoscommon_103((&T29_));
			if (NIM_UNLIKELY(*nimErr_)) goto LA27_;
			raiseOSError__stdZoserrors_98(err, colontmpD__2);
			if (NIM_UNLIKELY(*nimErr_)) goto LA27_;
			{
				LA27_:;
			}
			{
				eqdestroy___stdZassertions_30((&colontmpD__2));
			}
			if (NIM_UNLIKELY(*nimErr_)) goto BeforeRet_;
		}
		LA25_: ;
		status2 = copyfile_state_free(state);
		{
			NimStringV2 colontmpD__3;
			NI32 T37_;
			tyTuple__UV3llMMYFckfui8YMBuUZA T38_;
			if (!!((status2 == ((NI32)0)))) goto LA34_;
			colontmpD__3.len = 0; colontmpD__3.p = NIM_NIL;
			T37_ = (NI32)0;
			T37_ = osLastError__stdZoserrors_101();
			if (NIM_UNLIKELY(*nimErr_)) goto LA36_;
			T38_.Field0 = source__eoCVFNpLZVLXwyKu7SJhzg;
			T38_.Field1 = dest__C3yHuHrfbm8qUZjgenJyMA;
			colontmpD__3 = dollar___stdZprivateZoscommon_103((&T38_));
			if (NIM_UNLIKELY(*nimErr_)) goto LA36_;
			raiseOSError__stdZoserrors_98(T37_, colontmpD__3);
			if (NIM_UNLIKELY(*nimErr_)) goto LA36_;
			{
				LA36_:;
			}
			{
				eqdestroy___stdZassertions_30((&colontmpD__3));
			}
			if (NIM_UNLIKELY(*nimErr_)) goto BeforeRet_;
		}
		LA34_: ;
	}
	LA13_: ;
	}BeforeRet_: ;
}
N_LIB_PRIVATE N_NIMCALL(NIM_BOOL, nostryRemoveFile)(NimStringV2 file__SkPQ5IAKGO9cnoeVcTqgQ3w) {
	NIM_BOOL result;
	result = (NIM_BOOL)0;
	result = NIM_TRUE;
	{
		NIM_BOOL T3_;
		int T4_;
		T3_ = (NIM_BOOL)0;
		T4_ = (int)0;
		T4_ = unlink(nimToCStringConv(file__SkPQ5IAKGO9cnoeVcTqgQ3w));
		T3_ = !((T4_ == ((NI32)0)));
		if (!(T3_)) goto LA5_;
		T3_ = !((errno == ENOENT));
		LA5_: ;
		if (!T3_) goto LA6_;
		result = NIM_FALSE;
	}
	LA6_: ;
	return result;
}
N_LIB_PRIVATE N_NIMCALL(void, nosremoveFile)(NimStringV2 file__J7TxM2NvlX9btMhQD9bZz39bA) {
NIM_BOOL* nimErr_;
{nimErr_ = nimErrorFlag();
	{
		NIM_BOOL T3_;
		NI32 T6_;
		T3_ = (NIM_BOOL)0;
		T3_ = nostryRemoveFile(file__J7TxM2NvlX9btMhQD9bZz39bA);
		if (NIM_UNLIKELY(*nimErr_)) goto BeforeRet_;
		if (!!(T3_)) goto LA4_;
		T6_ = (NI32)0;
		T6_ = osLastError__stdZoserrors_101();
		if (NIM_UNLIKELY(*nimErr_)) goto BeforeRet_;
		raiseOSError__stdZoserrors_98(T6_, file__J7TxM2NvlX9btMhQD9bZz39bA);
		if (NIM_UNLIKELY(*nimErr_)) goto BeforeRet_;
	}
	LA4_: ;
	}BeforeRet_: ;
}
static N_INLINE(void, popCurrentException)(void) {
	eqcopy___stdZtypedthreads_194(&currException__system_3940, (*currException__system_3940).up, NIM_FALSE);
}
N_LIB_PRIVATE N_NIMCALL(void, nosmoveFile)(NimStringV2 source__PbhPTnLQrpW54wQ6Wx9cCwQ, NimStringV2 dest__OatSPDCla4s5V9cfRdFrXig) {
NIM_BOOL* nimErr_;
{nimErr_ = nimErrorFlag();
	{
		NIM_BOOL T3_;
		T3_ = (NIM_BOOL)0;
		T3_ = tryMoveFSObject__stdZprivateZoscommon_96(source__PbhPTnLQrpW54wQ6Wx9cCwQ, dest__OatSPDCla4s5V9cfRdFrXig, NIM_FALSE);
		if (NIM_UNLIKELY(*nimErr_)) goto BeforeRet_;
		if (!!(T3_)) goto LA4_;
		noscopyFile(source__PbhPTnLQrpW54wQ6Wx9cCwQ, dest__OatSPDCla4s5V9cfRdFrXig, 1);
		if (NIM_UNLIKELY(*nimErr_)) goto BeforeRet_;
		nosremoveFile(source__PbhPTnLQrpW54wQ6Wx9cCwQ);
		if (NIM_UNLIKELY(*nimErr_)) goto LA6_;
		if (NIM_UNLIKELY(*nimErr_)) {
			LA6_:;
			{
				NIM_BOOL T10_;
				*nimErr_ = NIM_FALSE;
				T10_ = (NIM_BOOL)0;
				T10_ = nostryRemoveFile(dest__OatSPDCla4s5V9cfRdFrXig);
				if (NIM_UNLIKELY(*nimErr_)) goto LA8_;
				(void)(T10_);
				reraiseException();
goto LA8_;
				popCurrentException();
				LA8_:;
			}
		}
		if (NIM_UNLIKELY(*nimErr_)) goto BeforeRet_;
	}
	LA4_: ;
	}BeforeRet_: ;
}
